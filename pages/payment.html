<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>

    <link rel="stylesheet" href="../assets/css/ownerhome.css">
    <link rel="stylesheet" href="../assets/css/workerHome.css">
    <link rel="stylesheet" href="../assets/css/payment.css">

</head>

<body>
    <header>
        <div>
            <img src="../assets/Images/Logo.png" alt="Logo">
        </div>

        <nav>
            <div>
                <a onclick="reqList()">Requirement List</a>
                <!-- <a>Search</a> -->
                <a href="">Chat</a>
                <a onclick="notification()">Notification</a>
                <a>Payment</a>
                <a onclick="profile()">profile</a>
                <a href="../index.html">LogOut</a>
            </div>
        </nav>
    </header>
    <section class="filters">
        <p>Filter By</p>
        <a onclick="allJobs()">All</a>
        <a onclick="Fpaid()">Paid</a>
        <a onclick="unPaid()">Unpaid</a>
        <a href="">Pending</a>
    </section>
    <main id="main">


        <section class="listView">



        </section>


        <section class="detailSec">

            </div>
        </section>


    </main>



</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- Toastr -->
<link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script type="text/javascript">
    // Default Configuration
    $(document).ready(function () {
        toastr.options = {
            'closeButton': true,
            'debug': false,
            'newestOnTop': false,
            'progressBar': false,
            'positionClass': 'toast-top-right',
            'preventDuplicates': false,
            'showDuration': '1000',
            'hideDuration': '1000',
            'timeOut': '5000',
            'extendedTimeOut': '1000',
            'showEasing': 'swing',
            'hideEasing': 'linear',
            'showMethod': 'fadeIn',
            'hideMethod': 'fadeOut',
        }
    });

    // Toast Image and Progress Bar
    $('#image').click(function (event) {
        toastr.options.progressBar = true,
            toastr.info('<img src="https://image.flaticon.com/icons/svg/34/34579.svg" style="width:150px;">', 'Toast Image')
    });


    // Toast Position
    $('#position').click(function (event) {
        var pos = $('input[name=position]:checked', '#positionForm').val();
        toastr.options.positionClass = "toast-" + pos;
        toastr.options.preventDuplicates = false;
        toastr.info('This sample position', 'Toast Position')
    });
</script>
<script src="../assets/JS/payment.js"></script>
<script>

    let url = location.search;
    let urlParams = new URLSearchParams(url);
    let paymentfilter = urlParams.get("paymentfilter");
    console.log(paymentfilter);

    let allCompletedJobs = JSON.parse(localStorage.getItem("completedJobs"));
    let completedJobs = JSON.parse(localStorage.getItem("completedJobs"))
    if (paymentfilter == "paid") {
        completedJobs = allCompletedJobs.filter((F) => F.paid == "Paid");
    }

    if (paymentfilter == "unpaid") {
        completedJobs = allCompletedJobs.filter((F) => F.paid == "unPaid");
    }




    for (let i = 0; i < completedJobs.length; i++) {

        let listcard = document.createElement("div");
        listcard.setAttribute("class", "listcard");

        let listProfile = document.createElement("div");
        listProfile.setAttribute("class", "listProfile")
        listcard.append(listProfile);

        let listProfile_img = document.createElement("img");
        listProfile_img.setAttribute("src", "../assets/Images/profile2.jpg");
        listProfile_img.setAttribute("alt", "image");
        listProfile.append(listProfile_img);

        let workerDetails = document.createElement("div");
        workerDetails.setAttribute("class", "workerDetails");
        listcard.append(workerDetails);

        let name = document.createElement("div");
        name.setAttribute("class", "name");
        name.innerHTML = `${completedJobs[i]["applierName"]}`;
        workerDetails.append(name);

        let jobid = document.createElement("div");
        jobid.innerHTML = `${completedJobs[i]["jobID"]}`;
        jobid.setAttribute("class", "jobid");
        workerDetails.append(jobid);

        let status = document.createElement("div");
        status.innerHTML = `${completedJobs[i]["paid"]}`;
        status.setAttribute("class", "status");
        workerDetails.append(status);

        let Pay = document.createElement("div");
        Pay.setAttribute("class", "Pay");
        Pay.setAttribute("onclick", `detailView(${completedJobs[i]["aplliedJobId"]})`)
        listcard.append(Pay);

        let payButton = document.createElement("button");
        payButton.innerHTML = "Pay";
        Pay.append(payButton);

        document.querySelector(".listView").append(listcard);
    }

    function reqList() {
        location.href = "Ownerhome.html" + location.search;
    }

    function paidDetails() {
        event.preventDefault();
        let paymentJob = JSON.parse(localStorage.getItem("currentDataPayDetail"));
        let completedJobs = JSON.parse(localStorage.getItem("completedJobs"));
        let paidAmount = document.getElementById("amountboxUPI").value;
        let refImage = document.getElementById("uploadPhotoboxUPI").value;

        let currentPaymentJob = completedJobs.find(
            (F) => F.aplliedJobId == paymentJob
        );

        if (currentPaymentJob["paid"] != "Paid") {
            //    add payment datas in completed jobs
            currentPaymentJob["paid"] = "Paid";
            currentPaymentJob["paidAmount"] = paidAmount;
            currentPaymentJob["refImage"] = refImage;

            //    add payment datas in apllyJob
            let applyJobs = JSON.parse(localStorage.getItem("apllyJob"));
            let cntApplyJob = applyJobs.find((F) => F.aplliedJobId == currentPaymentJob.aplliedJobId);
            let cntApplyJobIndex = applyJobs.indexOf(cntApplyJob);

            cntApplyJob["paid"] = "Paid";
            cntApplyJob["paidAmount"] = paidAmount;
            cntApplyJob["refImage"] = refImage;

            applyJobs[cntApplyJobIndex] = cntApplyJob;
            localStorage.setItem("apllyJob", JSON.stringify(applyJobs));

            // place a completed job 

            console.log(currentPaymentJob);
            let index = completedJobs.indexOf(currentPaymentJob);
            completedJobs[index] = currentPaymentJob;
            localStorage.setItem("completedJobs", JSON.stringify(completedJobs));
            console.log(currentPaymentJob);
            cancelPaid();
            return toastr.success("You paid to " + currentPaymentJob["applierName"]);
        }
        else {
            return toastr.error("You already paid to " + currentPaymentJob["applierName"] + " for this job");

        }

    }

    function notification() {
        location.href = "ownerNotification.html" + location.search;
    }

    function profile() {
        location.href = "profile.html" + location.search;
    }




    function allJobs() {
        if (paymentfilter == null) {
            location.href = location + "&&paymentfilter=all"
        }
        else {
            urlParams.set('paymentfilter', 'all');
            location.href = "payment.html?" + urlParams;

        }

    }

    function Fpaid() {
        if (paymentfilter == null) {
            location.href = location + "&&paymentfilter=paid"
        }
        else {
            urlParams.set('paymentfilter', 'paid');
            location.href = "payment.html?" + urlParams;
        }
    }

    function unPaid() {
        if (paymentfilter == null) {
            location.href = location + "&&paymentfilter=unpaid"
        }
        else {
            urlParams.set('paymentfilter', 'unpaid');
            location.href = "payment.html?" + urlParams;

        }
    }





</script>

</html>