<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Needs To Be Done</title>
    <link rel="icon" href="../assets/Images/barLogo.png" type="image/x-icon">

    <link rel="stylesheet" href="../assets/css/Register.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800&family=Barlow:wght@400;700&family=Outfit:wght@300&family=Roboto+Mono:ital,wght@0,300;1,300&family=Roboto+Slab:wght@300&family=Space+Mono:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<script src="../assets/JS/register.js"></script>
</head>
<!-- This is register page -->

<body>
    <section class="register">


        <!-- <div id="container">
            <header>Register new account</header>
            <form method="post" id="form">
                <fieldset>
                    <br />
                    <input type="text" name="username" id="UserName" placeholder="Username" required autofocus
                        autocomplete="fdgbsfgbds" pattern="[A-Za-z]{1,20}" title="Enter alphabet only">
                    <br /><br />
                    <input type="text" name="FullName" id="FullName" placeholder="Full Name" required
                        pattern="[A-Za-z]{1,20}" autocomplete="fdgbsfgbds" title="Enter alphabet only" />
                    <br /><br />
                    <input type="email" name="email" id="email" placeholder="E-mail" required>
                    <br /><br />
                    <input type="password" name="password" id="password" placeholder="Password" required
                        autocomplete="fdgbsfgbds" pattern="[A-Za-z]{1,20}"
                        title="Password should have uppercase and lowercase only">
                    <br /><br />
                    <input type="password" name="confirm-password" id="Rpassword" placeholder="Confirm Password"
                        required autocomplete="fdgbsfgbds" pattern="[A-Za-z]{1,20}"
                        title="RepeatPassword should have uppercase and lowercase only">
                    <br /> <br /> <br />
                    <label for="submit"></label>
                    <input type="submit" name="submit" id="submit" value="REGISTER">
                    <input type="reset" name="SignIn" value="SIGNIN" id="signIn" />
                </fieldset>
            </form>
        </div> -->

        <form id="form">
            <h2>Registration</h2>
            <div class="inputs">
                <div class="email">
                    <label for="email">
                        Email:- *
                    </label><br>
                    <input type="emial" id="email" placeholder="example@gmail.com" required />
                </div>

                <div class="password">
                    <label for="password">Password:- *</label> <br>
                    <input type="password" id="password" pattern="[A-za-z]{8,}" placeholder="Examplepassword"
                        required />
                    <i id="passwordEye" onclick="passwordEye()" class="fa fa-eye"></i>
                    <br>
                    <p>Password should have one UpperCase,LowerCase and more than
                        7 charecters</p>

                </div>

                <div class="repeatPassword">
                    <label for="repeatPassword">
                        Confirm password:- *
                    </label><br>
                    <input type="password" id="repeatPassword" pattern="[A-za-z]{8,}" required
                        placeholder="Examplepassword" /><i id="repeatPasswordEye" onclick="RepasswordEye()"
                        class="fa fa-eye"></i>
                    <br>
                    <p>Confirm password should be same as password</p>
                </div>


            </div>

            <div class="buttons">
                <button id="reset" type="reset"> <img src="../assets/Images/cross.svg" alt="cancelImage"></button>
                <button id="submit" type="submit"><img src="../assets/Images/tick.svg" alt="tickImage"></button>
            </div>

            <p class="signIn">If you already have an account? <a href="./Signin.html">SignIn</a></p>
        </form>

        <div class="registerIllutration">
            <img src="../assets/Images/register.avif" alt="image">
        </div>


    </section>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init("PJgY6h-r_KG_ejDC3");
        })();
    </script>
    <script>


        // To get the signUp form
        signUpform = document.getElementById("form");
        // To get the URL datas
        let url = location.search;
        let urlParams = new URLSearchParams(url);
        let type = urlParams.get("type");
        console.log(type);

        // To add some functions while clicking the submit button
        signUpform.addEventListener("submit", function (event) {
            try {
                event.preventDefault();
                // To check the type of the register
                let userData = []
                if (type == "owner") {
                    if (localStorage.getItem("register") != null) {
                        userData = JSON.parse(localStorage.getItem("register"))
                    }


                }

                else {

                    if (localStorage.getItem("workerRegister") != null) {

                        userData = JSON.parse(localStorage.getItem("workerRegister"))
                    }
                }




                // To get the register form datas
                let match = false;
                let id = Date.now();
                const Email = document.getElementById('email').value.toLowerCase();
                const Password = document.getElementById('password').value;
                const RPassword = document.getElementById('repeatPassword').value;
                // To generate the OTP
                let digits = '0123456789';
                let OTP = '';
                for (let i = 0; i < 4; i++) {
                    OTP += digits[Math.floor(Math.random() * 10)];
                }
                // To send email for verification with the OTP
                sendMail(OTP)


                // To get the all login Emails
                let allEmail = [];
                if (localStorage.getItem("allEmail") != null) {
                    allEmail = JSON.parse(localStorage.getItem("allEmail"))
                }
                // To check the password and repeat password is equal
                if (Password != RPassword) {
                    alert("Password and Repeat password not match")
                }

                else {

                    // To check the email is already exist or not
                    if (type == "owner") {
                        for (let i = 0; i < allEmail.length; i++) {
                            if (Email == allEmail[i]) {
                                match = true;
                            }


                        }

                        if (match == true) {
                            return alert("Email is already Exist");

                        }






                        else {
                            // To verify the OTP
                            let otpChecked = checkVerificationCode(OTP);
                            if (otpChecked == true) {
                                // To add the datas in the owner register and biodata
                                allEmail.push(Email);
                                localStorage.setItem("allEmail", JSON.stringify(allEmail))
                                let userObj = {
                                    Email, Password: encryptPassword(Password), RPassword: encryptPassword(RPassword), id
                                }
                                console.log(userObj)

                                userData.push(userObj);
                                const str = JSON.stringify(userData);
                                localStorage.setItem("register", str)
                                console.log(str)

                                let LoggedUser = {
                                    Email,
                                    id
                                }

                                localStorage.setItem("Login", JSON.stringify(LoggedUser));
                                console.log(LoggedUser);
                                window.location.href = "Bio.html?type=" + type;
                            }

                            else {
                                alert("Your OTP is incorrect")
                            }

                        }

                    }




                    else {
                        // To check the email is already exist or not
                        for (let i = 0; i <= allEmail.length; i++) {

                            if (Email == allEmail[i]) {

                                match = true;

                            }

                        }





                        if (match == true) {
                            return alert("Email is already Exist");
                        }

                        else {
                            // To verify the OTP
                            let otpChecked = checkVerificationCode(OTP);
                            if (otpChecked == true) {
                                // To add the datas in workerRegister and the biodata
                                allEmail.push(Email);
                                localStorage.setItem("allEmail", JSON.stringify(allEmail))
                                let userObj = {
                                    Email, Password: encryptPassword(Password), RPassword: encryptPassword(RPassword), id
                                }
                                console.log(userObj)

                                userData.push(userObj);
                                const str = JSON.stringify(userData);
                                localStorage.setItem("workerRegister", str)
                                console.log(str)
                                let userLoggedIn = {
                                    Email,
                                    id
                                }
                                localStorage.setItem("Login", JSON.stringify(userLoggedIn));
                                return location.href = "Bio.html?type=" + type;
                            }
                            else {
                                return alert("Your OTP is incorrect")
                            }
                        }


                    }






                }

                // To add last registered data in localStorage as logIn
                let allReg;
                let Bio = JSON.parse(localStorage.getItem("BIO"));
                if (type == "worker") {
                    allReg = JSON.parse(localStorage.getItem("workerRegister"));
                    Bio = Bio.find((F) => F.Email == allReg[allReg.length - 1].Email);
                }
                else {
                    allReg = JSON.parse(localStorage.getItem("Register"));
                    Bio = Bio.find((F) => F.Email == allReg[allReg.length - 1].Email);
                }

                let Login = {
                    Email: Bio.Email,
                    id: Bio.id,

                }
                localStorage.setItem("Login", JSON.stringify(Login))
            }
            catch (err) {
                console.error(err);
            }
        })












    </script>

</body>

</html>