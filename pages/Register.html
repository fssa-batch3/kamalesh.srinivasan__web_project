<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link rel="stylesheet" href="../assets/css/Register.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@700;800&family=Barlow:wght@400;700&family=Outfit:wght@300&family=Roboto+Mono:ital,wght@0,300;1,300&family=Roboto+Slab:wght@300&family=Space+Mono:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />

    <script src="../assets/JS/register.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <script type="text/javascript">
        (function () {
            emailjs.init("PJgY6h-r_KG_ejDC3");
        })();
    </script>
</head>
<!-- This is register page -->

<body>
    <section>


        <div id="container">
            <header>Register new account</header>
            <form method="post" id="form">
                <fieldset>
                    <br />
                    <input type="text" name="username" id="UserName" placeholder="Username" required autofocus
                        autocomplete="fdgbsfgbds" pattern="[A-Za-z]{1,20}" title="Enter alphabet only">
                    <br /><br />
                    <input type="text" name="FullName" id="FullName" placeholder="Full Name" required
                        pattern="[A-Za-z]{1,20}" autocomplete="fdgbsfgbds" title="Enter alphabet only" />
                    <br /><br />
                    <input type="email" name="email" id="email" placeholder="E-mail" required>
                    <br /><br />
                    <input type="password" name="password" id="password" placeholder="Password" required
                        autocomplete="fdgbsfgbds" pattern="[A-Za-z]{1,20}"
                        title="Password should have uppercase and lowercase only">
                    <br /><br />
                    <input type="password" name="confirm-password" id="Rpassword" placeholder="Confirm Password"
                        required autocomplete="fdgbsfgbds" pattern="[A-Za-z]{1,20}"
                        title="RepeatPassword should have uppercase and lowercase only">
                    <br /> <br /> <br />
                    <label for="submit"></label>
                    <input type="submit" name="submit" id="submit" value="REGISTER">
                    <input type="reset" name="SignIn" value="SIGNIN" id="signIn" />
                </fieldset>
            </form>
        </div>
        <script>



            document.getElementById("signIn").addEventListener("click", (event) => {
                location.href = "Signin.html"
            })
            signUpform = document.getElementById("form");

            let url = location.search;
            let urlParams = new URLSearchParams(url);
            let type = urlParams.get("type");
            console.log(type);
            signUpform.addEventListener("submit", function (event) {
                event.preventDefault();
                sendMail();
                let userData = []


                if (type == "owner") {
                    if (localStorage.getItem("register") != null) {
                        userData = JSON.parse(localStorage.getItem("register"))
                    }


                }

                else {

                    if (localStorage.getItem("workerRegister") != null) {

                        userData = JSON.parse(localStorage.getItem("workerRegister"))
                    }
                }





                let match = false;
                let id = Date.now();
                const FullName = document.getElementById('FullName').value;
                const Email = document.getElementById('email').value.toLowerCase();
                const UserName = document.getElementById('UserName').value;
                const Password = document.getElementById('password').value;
                const RPassword = document.getElementById('Rpassword').value;

                let digits = '0123456789';
                let OTP = '';
                for (let i = 0; i < 4; i++) {
                    OTP += digits[Math.floor(Math.random() * 10)];
                }


                console.log(OTP)

                sendMail(OTP)


                let allEmail = [];

                if (localStorage.getItem("allEmail") != null) {
                    allEmail = JSON.parse(localStorage.getItem("allEmail"))
                }
                if (Password != RPassword) {
                    alert("Password and Repeat password not match")
                }

                else {

                    if (type == "owner") {
                        for (let i = 0; i < allEmail.length; i++) {
                            if (Email == allEmail[i]) {
                                match = true;
                            }


                        }

                        if (match == true) {
                            return alert("Email is already Exist");

                        }






                        else {
                            let otpChecked = checkVerificationCode(OTP);
                            if (otpChecked == true) {
                                allEmail.push(Email);
                                localStorage.setItem("allEmail", JSON.stringify(allEmail))
                                let userObj = {
                                    Email, UserName, Password: encryptPassword(Password), RPassword: encryptPassword(RPassword), id
                                }
                                console.log(userObj)

                                userData.push(userObj);
                                const str = JSON.stringify(userData);
                                localStorage.setItem("register", str)
                                console.log(str)

                                let LoggedUser = {
                                    Email,
                                    id
                                }

                                localStorage.setItem("Login", JSON.stringify(LoggedUser));
                                console.log(LoggedUser);
                                window.location.href = "Bio.html?type=" + type;
                            }

                            else {
                                alert("Your OTP is incorrect")
                            }

                        }

                    }




                    else {
                        for (let i = 0; i <= allEmail.length; i++) {
                            console.log("workerElse")

                            if (Email == allEmail[i]) {

                                match = true;

                            }

                        }





                        if (match == true) {
                            return alert("Email is already Exist");
                        }

                        else {
                            let otpChecked = checkVerificationCode(OTP);
                            if (otpChecked == true) {
                                allEmail.push(Email);
                                localStorage.setItem("allEmail", JSON.stringify(allEmail))
                                let userObj = {
                                    FullName, Email, Password: encryptPassword(Password), RPassword: encryptPassword(RPassword), RPassword, id
                                }
                                console.log(userObj)

                                userData.push(userObj);
                                const str = JSON.stringify(userData);
                                localStorage.setItem("workerRegister", str)
                                console.log(str)
                                let userLoggedIn = {
                                    Email,
                                    id
                                }
                                localStorage.setItem("Login", JSON.stringify(userLoggedIn));
                                // console.log(logIn)
                                return location.href = "Bio.html?type=" + type;
                            }
                            else {
                                return alert("Your OTP is incorrect")
                            }
                        }


                    }






                }

                let allReg;
                let Bio = JSON.parse(localStorage.getItem("BIO"));
                if (type == "worker") {
                    allReg = JSON.parse(localStorage.getItem("workerRegister"));
                    Bio = Bio.find((F) => F.Email == allReg[allReg.length - 1].Email);
                }

                let Login = {
                    Email: Bio.Email,
                    id: Bio.id,

                }






                localStorage.setItem("Login", JSON.stringify(Login))








            })












        </script>
    </section>
</body>

</html>